#!/usr/bin/ksh

user=$1
database=$2


createTable()
{
	clear
	echo "Enter table name"
	read tname

	f=0
	for t in `awk -F: '{print $1}' $user/$database/meta` ; do
		if [ "$tname" == "$t" ]; then
			f=1
			break
		fi
	done
	if [[ $f -eq 1 ]]; then
		echo "Table is already exists"
	else
	 	touch $user/$database/$tname
		echo "Enter number of columns"
		read num
		columns[0]=$tname
		columns[1]=$num
		for (( i = 1; i <= num; i++ )); do
			echo "Enter column number" $i "name:"
			read cname
			columns[(($i+1))]=$cname
		done
		echo ${columns[*]}|sed 's/ /:/g'>>$user/$database/meta
	fi
	read
	clear
}


displayTable()
{
	clear
	echo "Enter table name:"
	read tname

	f=0
	for t in `awk -F: '{print $1}' $user/$database/meta` ; do
		if [ "$tname" == "$t" ]; then
			f=1
			break
		fi
	done
	if [[ $f -eq 0 ]]; then
		echo "Table is not found"
	else
	 	cnum=$(grep $tname $user/$database/meta|cut -d":" -f2)
		for (( c = 0; c < cnum; c++ )); do
			part=$(($c+3))
			col=$(grep $tname $user/$database/meta|cut -d":" -f $part)
			columns[c]=$col
		done
		echo ${columns[*]}|sed 's/ /'"\t"'/g'
		echo "_________________________________________________________________"
		awk -F: '{print $0}' $user/$database/$tname|tr ':' '\t'
	fi

	read
	clear
}


clear
select d_choice in "Edit table" "List tables" "Create table" "Delete table" "Display table's rows" "Back"
do
	case $d_choice in

		"Edit table" ) clear
				echo "Enter table name"
				read ustable

				f=0
				for t in `awk -F: '{print $1}' $user/$database/meta` ; do
					if [ "$ustable" == "$t" ]; then
						f=1
						break
					fi
				done
				if [[ $f -eq 0 ]]; then
					echo "Table is not found"
				else
				 	./edit $user $database $ustable
				fi
				read
				clear
				;;

		"List tables" ) clear
				awk -F: '{print $1}' $user/$database/meta
				read
				clear
				;;

		"Create table" ) createTable
				;;

		"Delete table" ) clear
				echo "Enter table name"
				read dname

				f=0
				for t in `awk -F: '{print $1}' $user/$database/meta` ; do
					if [ "$dname" == "$t" ]; then
						f=1
						break
					fi
				done
				if [[ $f -eq 0 ]]; then
					echo "Table is not found"
				else
					echo "Are you sure you want to delete this table ? (y/n)"
					read r
					while [ "$r" != "y" ] && [ "$r" != "n" ]; do
						echo "Wrong answer"	
						echo "Are you sure you want to delete it ? (y/n)"
						read r
					done
					if [ "$r" == "y" ]; then
						rm $user/$database/$dname
						sed -i '/^'"$dname"':/d' $user/$database/meta		 
						echo "Table deleted succssfuly"
					elif [ "$r" == "n" ]; then
						echo "We are good"
					fi
				fi

				read
				clear
				;;

		"Display table's rows" ) displayTable
				;;

		"Back" ) break
				;;

		* ) printf $REPLY" is not an option!\n"
				;;
	esac
done


